## 两阶段提交

由于存在redo log 和 binlog ，而他们两是相互独立的。而事务提交必须确保两者`同时有效`。不然会出现不一致的情形。

- 阶段1：`redo log` 写盘，InnoDB 事务进入 `prepare` 状态
- 阶段2：`binlog` 写盘，InooDB 事务进入 `commit` 状态

**时间1宕机**：这个时候 redo log已经写入磁盘。bin log没有刷到磁盘所以会消失。服务器从故障中恢复时，读取磁盘中的redo log ，但是由于对应的redo log项还是prepare状态，就要判断binlog 是否完整，如果binlog完整则提交事务，如果binlog不完整则回滚事务。

**时间2宕机**：redo log 和 binlog都已经存磁盘，从redo log恢复即可

![](https://user-gold-cdn.xitu.io/2019/5/18/16aca158bd2eef8c?imageView2/0/w/1280/h/960/ignore-error/1)

### 联系

**共同的数据字段 ： XID**

- 崩溃恢复的时候，会按顺序扫描 redo log：如果碰到既有 prepare、又有 commit 的 redo log，就直接提交；

- 如果碰到只有 parepare、而没有 commit 的 redo log，就根据 XID 去 bin log 找对应的事务。