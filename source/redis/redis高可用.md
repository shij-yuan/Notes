# redis高可用

## 持久化

RDB & AOF

## 复制

实现了数据的多机备份以及对于读操作的负载均衡和简单的故障恢复。

缺陷是故障恢复无法自动化、写操作无法负载均衡、存储能力受到单机的限制。

## 哨兵

在复制的基础上，哨兵实现了 **自动化** 的 **故障恢复**。

缺陷是 **写操作** 无法 **负载均衡**，**存储能力** 受到 **单机** 的限制。

![](https://user-gold-cdn.xitu.io/2018/8/22/16560ce61dbc4eeb?imageView2/0/w/1280/h/960/ignore-error/1)



哨兵的主要功能包括 **主节点存活检测**、**主从运行情况检测**、**自动故障转移**、**主从切换**。

- **自动故障转移**

    当 **主节点** 不能正常工作时，`Sentinel` 会开始一次 **自动的** 故障转移操作，它会将与 **失效主节点**是 **主从关系** 的其中一个 **从节点** 升级为新的 **主节点**，并且将其他的 **从节点** 指向 **新的主节点**。

- **配置提供者**

    在 `Redis Sentinel` 模式下，**客户端应用** 在初始化时连接的是 `Sentinel` **节点集合**，从中获取 **主节点** 的信息。



### 工作方式

1. 每个 `Sentinel` 以 **每秒钟** 一次的频率，向它所知的 **主服务器**、**从服务器** 以及其他 `Sentinel` **实例** 发送一个 `PING` 命令。
2. 如果一个 **实例**距离 **最后一次** 有效回复 `PING` 命令的时间超过 `down-after-milliseconds` 所指定的值，那么这个实例会被 `Sentinel` 标记为 **主观下线**。
3. 若主节点被标记为主管下线，所有 `Sentinel` 节点要以 **每秒一次** 的频率确认 **主服务器** 的确进入了 **主观下线** 状态。
4. 有 **足够数量** 的 `Sentinel`在指定的 **时间范围** 内同意这一判断，那么这个 **主服务器** 被标记为 **客观下线**。
5. 投票自动选出新的 **主节点**。将剩余的 **从节点** 指向 **新的主节点** 进行 **数据复制**。



## 集群

集群模式自动将数据进行分片，每个 master 上放一部分数据，在多个 Redis 节点之间进行数据共享。

### 数据分片

一个 Redis 集群包含 16384 个哈希槽（hash slot）， 数据库中的每个键都属于这 16384 个哈希槽的其中一个， 集群使用公式 CRC16(key) % 16384 来计算键 key 属于哪个槽。

集群中的每个节点负责处理一部分哈希槽

#### 主从复制

 集群中的每个节点都有 1 个至 N 个复制品，其中一个复制品为主节点（master）， 而其余的 N-1 个复制品为从节点（slave）。